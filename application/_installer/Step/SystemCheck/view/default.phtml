<?php
/**
 * Jet compatibility test - all in one
 *
 * This script can be used as standalone
 *
 *
 * @copyright Copyright (c) 2012-2013 Miroslav Marek <mirek.marek.2m@gmail.com>
 * @license http://www.php-jet.net/php-jet/license.txt
 * @author Miroslav Marek <mirek.marek.2m@gmail.com>
 * @version <%VERSION%>
 *
 * @category Jet
 * @package Installer
 */
class JetCompatibilityTester_TestResult {
	/**
	 * @var bool
	 */
	protected $required = true;
	/**
	 * @var string
	 */
	protected $title = '';
	/**
	 * @var string
	 */
	protected $description = '';

	/**
	 * @var bool
	 */
	protected $passed = false;
	/**
	 * @var string
	 */
	protected $result_message = '';

	public function __construct( $required, $title, $description ) {
		$this->required = (bool)$required;
		$this->title = (string)$title;
		$this->description = (string)$description;
	}

	/**
	 * @param string $description
	 */
	public function setDescription($description) {
		$this->description = (string)$description;
	}

	/**
	 * @return string
	 */
	public function getDescription() {
		return $this->description;
	}

	/**
	 * @param bool $passed
	 */
	public function setPassed($passed) {
		$this->passed = (bool)$passed;
	}

	/**
	 * @return bool
	 */
	public function getPassed() {
		return $this->passed;
	}

	/**
	 * @param bool $required
	 */
	public function setRequired($required) {
		$this->required = (bool)$required;
	}

	/**
	 * @return bool
	 */
	public function getRequired() {
		return $this->required;
	}

	/**
	 * @param string $result_message
	 */
	public function setResultMessage($result_message) {
		$this->result_message = (string)$result_message;
	}

	/**
	 * @return string
	 */
	public function getResultMessage() {
		return $this->result_message;
	}

	/**
	 * @param string $title
	 */
	public function setTitle($title) {
		$this->title = (string)$title;
	}

	/**
	 * @return string
	 */
	public function getTitle() {
		return $this->title;
	}

	/**
	 * @return bool
	 */
	public function getIsError() {
		return ($this->required && !$this->passed);
	}

	/**
	 * @return bool
	 */
	public function getIsWarning() {
		return (!$this->required && !$this->passed);
	}

	/**
	 *
	 */
	public function showResultRow() {
		$css_class = 'isok';
		$icon = 'data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAADwklEQVRIidWVa0ybVRzGn/O29vLSdqX0ArQMGNahg0yBRaezuCxuLH5wyeaVlGVLFvWLS5YlJibbkqmJxkjiRFC8ZDMwpwNhBdoBdahsMjpQxm7C6EvtjdIL6woIwtsev7hlbhXnLh/2JOfTOef3/P/nnzyHUEpxN8XcVfo9ZSCrISVZu7U/Zr2r0t9xA/ZzUpwXzu9t2HLElMsYrdLXSObVTUrpbS3pZygpeMsY7zpvpzsPbaetg0eo1MycEW1CJqX09jpIqSVFuf68kx9uqmYsZ5swEOzD8wc24u2KdwrE8xKbeD1R3rJBSjUpzhlfcuqjl2oEluFGDE7/gp8nTyCRycPmaoGcUQri89fNQHdIolTsFdVqD0qKFoKzn5DixRM5jn3masbiOYxziQE4+B5IcoXQETUudIw6qXBuHW+n0asGbC2R8140H3ule5v6coYlZT9ZngyeWkdKcmK5jqotNUzreBOGE0M4O38aaXollCEVxmwTI5GpMZP/24gP+LsDTaVYrovqmhpfaCnl/5iD3XxcvyiaakmtZwqvhWc0sEVZIWPvx5s/ZdpDbfDwLozwv0GbroHULYenLcwRQWL1jJX6r9xhpLuJwsgXWt5/tnINjQOuORe6x7rg2DawWBFTWfXfyQoAIKcltUgXyD5VZa5hvp+wwU894OhFaNI1wLAIIxYfx8gSplkb9V5bFEP/hFpG5IXN3gb8EO2EUCzANDOFjnErujf3GTAkan+ic/magvAKx77yKqbrcicCxAc3GYUmXQN+GLhwlONE+QnTbCP1Xf+kzOx7lIshUh4dmA4f9bXAeqkZCUEcccE8rJFmnNjelykbVdt3PbdH0D11DEGBHz6BBxqtGjMXeQy2DjnZ1dQ09cGNcAAgV9I0e6d2vUTE1inXSlQGbRYela+CXKhAnOGxUvEk7DEbgjQAV9wJVipF0BlFzxd9nLLsvlL3hpg3GfwfBgAge4OUycSKuoc3LktjVVI8IHoIGSI9EiSOEALw0N+RImXhdQfRU9vH5WzQmPpXOZNWntQAAOSVZF1KTFlfan48TZIuhIqqIRPKESQBsGIWHOdBz5f93CPlRlP7g70LwoEkYTe5g7Ynlsy8fPxrR0g4KQEjI5gWT8EgNmDMFUb/gTPOp19feVPwpAYAEKyY7WALmQp73U8RySU5lpFC+N1h/PrVeW7rrhefqte23RQcwMJpuqJ7adnSyrzIq6e30vy99zu/ofv1/zdt//PA2nOPPWN4M+PkHroj+1bi/IYh32ndO3/yv+kvrBgu89iR6ZIAAAAASUVORK5CYII=';

		if(!$this->passed) {

			if($this->required) {
				$icon = 'data:image/png;base64,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';
				$css_class = 'fail';
			} else {
				$icon = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAEi0lEQVRIiZWUS2xVVRRA1zn33M+7931LaQVKoX+gQAXKN1ApIEQxMX4iJkYTNUajhBiNn4nBDwwc6VQdEIdGB0aHOFBJjANjEKOGRCQKRdsCfY/Xd9997957joMGtSnQupM1OMne2Vl7n3PERx9qFhrt6RtUQ0nY8drNk8zsowL47m25oAZDe4b6ypNX6me+PXpxIfl739UzDRYYXtui7FsqrpWBZxZapEwW6vX5E7s6naOjIz2HkrCNL7/+7fuf/9Dvz1fz0AAsbDbQvmPv4POWSnDzHvfe2XkMcBdSKNEJCG5JV2/mzf51A56eriKiCrtGBhZv6pYv2QJuRZIuzKBneOf6x1xliOsNdFQjU5DcvbfzCFCc38BT6CY3RABd/bmjK3pXeI3aFFFlkubUFDIqs2XL8sUDy+Ur5QRuRj6Y32DDxq1rHvRUQhQ20K39xKU+0lpIPq+5Z0/H48DSWxvcajarii/29C7LUB2HTJ7CgffwD3xAKnyojrNtuL19/6B6wbMhMnPJSJBCQmrmYrnsun3bwKFCFprVMsoYpHSxpEdqBGnlGsXcNCObSk8A/f/XwOlfXXp29cBSlYZXMEkTPX0FrRto06QZhsSTFcSlc2zrT0sbV6jnbt5AgxGz8QKxY+OWnofzbkJ07Rp2EiLjMgiDMZr4z4vE4w30ZJNiLuLAcOZpz2G9p+C/1Bs3Nsj09hUOr13bSfPyBRxh8LIWvm2QgNAJqlpGGDASCCN2DVruzpXWkzD365EmAsf5lyAQm4Y3r3wgsMroOMFvKeE3q3i1vxB2Aem1EhQcbBeEAEJNvpiyb8g9clvAmqwD1wnLcw3c7h7/1XWDrST1EC9QOOM/4lydQk2VMR9vx3w2gm2aOFkQEkBAo8nuIY++NnkYcGYZiFqdwGeGDMNbN3cc9J0Epi7hjP+CdfUyIm+ReBZRZgmRlSM1BlF0ELYFSkJkyLZoRtc5T+UdVvkKfAVRfbaB7OrOHhvsLRGf/wE1fgEZNaAQgOsgBkew953A3nMCObAZlANBAJY9cxmjmNENDr2LxcvXdyEESHQGV4DnijuG+73dauwMcnIKSwG5HARFyLViEaNsB6V8hIghaIWgNLM4IaChyRUMo4PqEU8xGDsKOf3NPwZWR86802VfwZRDLAfwPfAyYPuQXwKNBpy8H744BNKG0hLwAvByYEnQKUQxe9ZadOY5PrMcUHbtK4ot9uiONWYoIMHxQPgSsh4U8pBtg/xSyLbPNJM2EEN1AioXwRVgNWG6AklMkDU8elfx4OufhkNJVDmtXHOWoOR3WC0uY5MT+FmBo22ksbASjYpCRHQZKikyk8VYFqYxDWGZtDZNfC0mrVlQtzF1g0kSlq1YRHub1Vef+Om0OHlqjOP3LSu2FdX+OExsBEaCMYCZebgaIUgMQkq00SQalDZoKYyKU0yLh99dIGdZSAxy2sjG5+f0J5+fLk+Ik6fGAKhe/BVR2o5uXKUR/k5j6jxR5QJxXCap1xA0IRVoEZHGBm0MQrh4+RKZYCUZbw2O6gV3EXCW9TuXA/A3HrzUaJE73FIAAAAASUVORK5CYII=';
				$css_class = 'warning';
			}
		}
		?>
		<tr class="<?php echo $css_class; ?>">
			<td class="resicon"><img src="<?php echo $icon; ?>"/></td>
			<td class="restitle"><b><?php echo $this->title;?></b><br/><?php echo $this->description; ?></td>
			<td class="resresult"><?php echo $this->result_message;?></td>
		</tr>
		<?php
	}

}

class JetCompatibilityTester {
	/**
	 * @var string
	 */
	protected $PHP_info = '';

	/**
	 * @var JetCompatibilityTester_TestResult[]
	 */
	protected $test_results = array();

	public function __construct() {
		foreach( array(
			         'function_exists',
			         'class_exists',
			         'version_compare',
			         'ini_get',
			         'ob_start',
			         'ob_end_clean',
			         'ob_get_contents',
			         'phpinfo'
		         ) as $required_function) {

			if( !function_exists($required_function) ) {
				die('Error: function \''.$required_function.'\' is required!');
			}
		}

		ob_start();
		phpinfo();
		$this->PHP_info = ob_get_contents();
		ob_end_clean();

	}

	/**
	 * @param string $title
	 * @param string $description
	 * @param callable $test
	 *
	 * @return bool
	 */
	public function test( $title, $description, callable $test ) {
		$test_result = new JetCompatibilityTester_TestResult(true, $title, $description);
		$test_result->setPassed( $test($test_result) );
		$this->test_results[] = $test_result;

		return $test_result->getPassed();
	}

	/**
	 * @param string $title
	 * @param string $description
	 * @param callable $test
	 *
	 * @return bool
	 */
	public function check( $title, $description, callable $test ) {
		$test_result = new JetCompatibilityTester_TestResult(false, $title, $description);
		$test_result->setPassed( $test($test_result) );
		$this->test_results[] = $test_result;

		return $test_result->getPassed();
	}


	public function testSystem() {

		$this->test(
			'PHP version',
			'PHP 5.4.4 or newer is required',
			function( JetCompatibilityTester_TestResult $test_result ) {
				$test_result->setResultMessage('PHP version: '.PHP_VERSION);
				return version_compare(PHP_VERSION, '5.4.4', '>=');
			}
		);

		$this->test(
			'PDO extension',
			'PHP PDO extension must be activated',
			function() {
				return extension_loaded('PDO');
			}
		);
		$this->check(
			'INTL extension',
			'PHP Internationalization Functions extension must be activated',
			function( JetCompatibilityTester_TestResult $test_result ) {
				$result = extension_loaded('intl');

				if(!$result) {
					$test_result->setResultMessage( '<b style="color:red">Internationalization support is limited!</b>' );
				}

				return $result;
			}
		);

		$this->test(
			'$_SERVER["REQUEST_URI"] value',
			'PHP $_SERVER["REQUEST_URI"] value must be available',
			function() {
				return isset($_SERVER['REQUEST_URI']);
			}
		);


		$this->check(
			'Redis support',
			'',
			function( JetCompatibilityTester_TestResult $test_result ) {
				$result = class_exists('Redis', false);
				if(!$result) {
					$test_result->setResultMessage( 'Redis support is not available (class Redis does not exist).<br/>Use Redis or Memcached for better performance.' );
				}

				return $result;
			}
		);

		$this->check(
			'Memcache support',
			'',
			function( JetCompatibilityTester_TestResult $test_result ) {
				$result = extension_loaded('memcache');
				if(!$result) {
					$test_result->setResultMessage( 'Memcache support is not available (memcache extension is not loaded).<br/>Use Redis or Memcached for better performance.' );
				}

				return $result;
			}
		);


		if( $this->check(
			'GD extension',
			'PHP GD extension should be activated', function() {
				return extension_loaded('gd');
			}
		) ) {
			$this->check(
				'GD Functions',
				'imagecreatefromjpeg, imagecreatefromgif, imagecreatefrompng, imagecolorallocatealpha, imagefilledrectangle, imagecopyresampled, imagejpeg, imagegif, imagepng',
				function( JetCompatibilityTester_TestResult $test_result ) {
					$functions = array('imagecreatefromjpeg','imagecreatefromgif','imagecreatefrompng','imagecolorallocatealpha','imagefilledrectangle','imagecopyresampled','imagejpeg','imagegif','imagepng');

					$OK = true;

					$na_function_names = array();

					foreach( $functions as $function_name ) {
						if(!function_exists($function_name)) {
							$na_function_names[] = '<i>'.$function_name.'</i> is not available';
							$OK = false;
						}
					}

					$na_function_names = implode('<br/>', $na_function_names);
					$test_result->setResultMessage($na_function_names);

					return $OK;
				}
			);
		}

		$this->check(
			'FileInfo extension',
			'PHP FileInfo extension should be activated',
			function() {
				return extension_loaded('fileinfo');
			}
		);

		$this->check(
			'PHP configuration: Max upload file size',
			'',
			function( JetCompatibilityTester_TestResult $test_result ) {
				$post_max_size_cv = $post_max_size = ini_get('post_max_size');
				$upload_max_filesize_cv = $upload_max_filesize = ini_get('upload_max_filesize');


				$post_max_size_unit = substr($post_max_size, -1);
				$upload_max_filesize_unit = substr($upload_max_filesize, -1);

				$units = array('' => 1, 'K'=>1024, 'M'=>1048576, 'G'=>1073741824);

				$post_max_size = $post_max_size*$units[$post_max_size_unit];
				$upload_max_filesize = $upload_max_filesize*$units[$upload_max_filesize_unit];

				if($post_max_size<=$upload_max_filesize) {
					$test_result->setResultMessage( '<i>post_max_size</i> ('.$post_max_size_cv.') should be greater then <i>upload_max_filesize</i> ('.$upload_max_filesize_cv.')' );
					return false;
				}

				if($upload_max_filesize<2097152) {
					$test_result->setResultMessage('<i>upload_max_filesize</i> ('.$upload_max_filesize_cv.') should be greater then 2MB');
					return false;
				}

				$test_result->setResultMessage( '<i>post_max_size</i>: '.$post_max_size_cv.'<br/><i>upload_max_filesize</i>:'.$upload_max_filesize_cv );

				return true;

			}
		);


		if( $this->check(
			'PHP configurations - paths',
			'open_basedir, upload_tmp_dir and session.save_path',
			function( JetCompatibilityTester_TestResult $test_result ) {
				$open_basedir = ini_get('open_basedir');

				if(!$open_basedir) {
					$test_result->setResultMessage( '<b style="color:red"><i>open_basedir</i> should be set!</b>' );
					return false;
				}
				return true;
			}
		)) {


			$this->test(
				'open_basedir vs upload_tmp_dir',
				'',
				function( JetCompatibilityTester_TestResult $test_result ) {
					$open_base_dirs = explode(':', ini_get('open_basedir'));
					$upload_tmp_dir = realpath( ini_get('upload_tmp_dir') );

					$result = false;

					foreach( $open_base_dirs as $open_base_dir ) {
						if(strpos($upload_tmp_dir, $open_base_dir )===0) {
							$result = true;
							break;
						}

					}


					if(!$result) {
						$test_result->setResultMessage('upload_tmp_dir is '.$upload_tmp_dir.' but open_basedir is '.$open_basedir);
					}

					return $result;
				}
			);

			$this->test(
				'open_basedir vs session.save_path',
				'',
				function( JetCompatibilityTester_TestResult $test_result ) {
					$open_base_dirs = explode(':', ini_get('open_basedir'));
					$session_save_path = realpath( ini_get('session.save_path') );

					$result = false;

					foreach( $open_base_dirs as $open_base_dir ) {
						if(strpos($session_save_path, $open_base_dir )===0) {
							$result = true;
							break;
						}

					}

					if(!$result) {
						$test_result->setResultMessage('session.save_path is '.$session_save_path.' but open_basedir is '.$open_basedir);
					}

					return $result;
				}
			);


		}

		foreach($this->test_results as $test_result) {
			if($test_result->getIsError()) {
				return false;
			}
		}

		return true;
	}

	public function showResult() {
		$errors_count = 0;
		$warnings_count = 0;
		?>
		<table>
			<?php foreach($this->test_results as $test_result):
				if($test_result->getIsError()) {
					$errors_count++;
				}
				if($test_result->getIsWarning()) {
					$warnings_count++;
				}
				?>
				<?php $test_result->showResultRow(); ?>
			<?php endforeach; ?>

		<?php
		$is_compatible = $errors_count==0;
		$all_passed = $warnings_count==0;

		?>
		<tr><td colspan="3">
		<?php if($is_compatible): ?>
			<?php if($all_passed): ?>
				<div class="resultmsg isok">The system is fully compatible with PHP Jet Platform!</div>
			<?php else: ?>
				<div class="resultmsg warning">The system is compatible with PHP Jet Platform. Please take care about warnings!</div>
			<?php endif; ?>
		<?php else: ?>
			<div class="resultmsg fail">Sorry, but the system is tom compatible with PHP Jet Platform!</div>
		<?php endif; ?>
		</td></tr>
		</table>
		<?php
	}
}

$tester = new JetCompatibilityTester();


?>

<style type="text/css">


	.isok {
		background-color: #aaaaaa;
	}

	.fail {
		background-color: #ff1111;
	}

	.warning {
		background-color: #ff9999;
	}

	table {
		padding: 0;
		margin: 0;
		border-collapse: collapse;
	}

	table td, table th {
		text-align: left;
		padding: 10px;
		vertical-align: top;
		border: 0 solid #c9c9c9;
		border-top-width: 1px;
		background-color: inherit;
	}

	.resicon {
	}

	.restitle {
	}

	.resresult {
	}

	.resultmsg {
		margin-top: 40px;
		margin-bottom: 40px;
		padding: 20px;
		border: 1px solid #000000;
	}

</style>


<?php if($tester->testSystem()) :?>
	<?php $tester->showResult(); ?>
<form method="post">
<input type="hidden" name="go" value="1">
<input type="submit" value="Next" class="btn btn-primary"/>
</form>
<?php else: ?>
	<?php $tester->showResult(); ?>
<?php endif; ?>